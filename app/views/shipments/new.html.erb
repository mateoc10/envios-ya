<script src="//maps.google.com/maps/api/js?key=AIzaSyCULAfBJit219O85L4mwt4nqVhBL9KARCQ"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->

<% provide(:title, 'Sign up') %>
<h1>Shipment</h1>

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <%= form_for(@shipment, url: shipments_create_path) do |f| %>
      <%= f.label 'Destination user email' %>
      <%= f.text_field :destination %>
      
      <%= f.label :payment %>
      <%= f.select :payment, options_for_select([["I pay"], ["He pays"], ["Both"]]) %>
      
      <%= f.label :Driver %>
      <%= f.collection_select :driver, Driver.order(:name), :id, :name, {:prompt => @select_value, :selected => :id}%>
      
      <div>
        <div id="map" style='width: 555px; height: 350px;' ></div>
      </div>

      <%= f.submit "Create shipment", class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<script type='text/javascript'>
  
    let markerList = [];

    handler = Gmaps.build('Google');
    handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      google.maps.event.addListener(handler.getMap(), 'click', function(latlng) {
        let markerLabel = "";
        if(markerList.length == 0) {
          markerLabel = "Origin";
        } else if (markerList.length == 1) {
          markerLabel = "Destiny";
        } else {
          for(i=0; i<markerList.length; i++){
            markerList[i].setMap(null);
          }
        }
        
        const marker = new google.maps.Marker(
          {
            "lat": latlng.latLng.lat(),
            "lng": latlng.latLng.lng(),
            "infowindow": markerLabel
          }
        );
        markerList.push(marker);
        markerList.map(marker => {marker.setMap(null)})
        handler.addMarkers(markerList);
        console.log(markerList);
      });
      
      handler.getMap().setCenter(new google.maps.LatLng(-34.90,-56.16));
      handler.getMap().setZoom(13);
      
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
    });
</script>